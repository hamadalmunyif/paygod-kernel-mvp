api_version: "paygod/v1"
kind: Pack
metadata:
  name: "critical-cve-blocker"
  version: "1.0.0"
  description: "Blocks deployment artifacts containing critical CVEs with CVSS score >= 9.0."
  maintainer: "security@paygod.org"
  tags: ["security", "cve", "vulnerability", "supply-chain"]

spec:
  inputs:
    - name: "scan_report"
      type: "observation"
      source: "trivy"
      schema:
        type: "object"
        properties:
          artifact_name: { type: "string" }
          vulnerabilities:
            type: "array"
            items:
              type: "object"
              properties:
                cve_id: { type: "string" }
                severity: { type: "string" }
                cvss_score: { type: "number" }
                status: { type: "string" }

  policy:
    rules:
      - name: "block-critical-cve"
        condition: "input.scan_report.vulnerabilities.any(v => v.cvss_score >= 9.0 and v.status != 'fixed')"
        decision: "deny"
        reason: "Artifact contains unpatched critical vulnerabilities (CVSS >= 9.0)."

      - name: "warn-high-cve"
        condition: "input.scan_report.vulnerabilities.any(v => v.cvss_score >= 7.0 and v.cvss_score < 9.0 and v.status != 'fixed')"
        decision: "flag"
        reason: "Artifact contains unpatched high severity vulnerabilities."

      - name: "allow-clean-artifact"
        condition: "not input.scan_report.vulnerabilities.any(v => v.cvss_score >= 7.0 and v.status != 'fixed')"
        decision: "allow"
        reason: "No critical or high vulnerabilities found."
