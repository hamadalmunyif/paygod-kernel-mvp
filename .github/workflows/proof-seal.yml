name: BAP Proof Seal

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  proof-seal:
    name: BAP Proof Seal
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps for schema validation
        run: |
          python -m pip install --upgrade pip
          if [ -f tools/requirements.txt ]; then
            pip install -r tools/requirements.txt
          else
            pip install jsonschema referencing
          fi

      # 1) Generate deterministic proof_run outputs (raw outputs)
      - name: Generate proof_run outputs
        shell: pwsh
        run: |
          pwsh -File tools/run_proof.ps1

      # 2) Wrap outputs into BAP envelopes (temp) + validate via tools/bap_validate.ps1
      - name: Seal proof_run outputs (BAP envelopes)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $outDir = "docs/examples/proof_run/outputs"
          if (-not (Test-Path $outDir)) { throw "Missing outputs dir: $outDir" }

          $tmp = Join-Path $env:RUNNER_TEMP "bap-proof-seal"
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null

          function Write-Utf8NoBom([string]$path, [string]$text) {
            $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
            [System.IO.File]::WriteAllText($path, $text + "`n", $utf8NoBom)
          }

          function New-Envelope([string]$kind, [string]$schemaRef, [object]$dataObj, [string]$ts) {
            [ordered]@{
              kind          = $kind
              schema_version= "1.0.0"
              schema_ref    = $schemaRef
              timestamp     = $ts
              producer      = @{ name="proof-seal-ci"; version="1.0.0" }
              correlation_id= "proof_run_ci"
              data          = $dataObj
            }
          }

          # Use deterministic timestamp from decision output
          $dec = Get-Content (Join-Path $outDir "decision.json") -Raw | ConvertFrom-Json
          $ts  = $dec.timestamp
          if (-not $ts) { $ts = "1970-01-01T00:00:00Z" }

          $map = @(
            @{ kind="decision";     schema="contracts/schemas/decision.schema.json";     file=(Join-Path $outDir "decision.json") },
            @{ kind="evidence";     schema="contracts/schemas/evidence.schema.json";     file=(Join-Path $outDir "evidence.json") },
            @{ kind="ledger_entry"; schema="contracts/schemas/ledger_entry.schema.json"; file=(Join-Path $outDir "ledger_entry.json") }
          )

          foreach ($m in $map) {
            $dataObj = Get-Content $m.file -Raw | ConvertFrom-Json
            $envObj  = New-Envelope $m.kind $m.schema $dataObj $ts
            $envJson = ($envObj | ConvertTo-Json -Depth 50)
            $envPath = Join-Path $tmp ("proof_run." + $m.kind + ".envelope.json")
            Write-Utf8NoBom $envPath $envJson

            pwsh -File tools/bap_validate.ps1 -InputPath $envPath -RepoRoot (Get-Location).Path
          }

      # 3) Validate pack examples: PASS must pass
      - name: Validate pack PASS examples
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $pass = @(
            "packs/core/bap-output-validator-guard/examples/pass.decision.json",
            "packs/core/bap-output-validator-guard/examples/pass.evidence.json"
          )
          foreach ($p in $pass) {
            pwsh -File tools/bap_validate.ps1 -InputPath $p -RepoRoot (Get-Location).Path
          }

      # 4) Validate pack FAIL examples: failure is expected
      - name: Validate pack FAIL examples (expected failure)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $fail = @(
            "packs/core/bap-output-validator-guard/examples/fail.bad_schema_version.json",
            "packs/core/bap-output-validator-guard/examples/fail.evidence_raw_payload.json"
          )
          foreach ($p in $fail) {
            pwsh -File tools/bap_validate.ps1 -InputPath $p -RepoRoot (Get-Location).Path
            if ($LASTEXITCODE -eq 0) {
              throw "❌ Validator unexpectedly PASSED fail example: $p"
            } else {
              Write-Host "✅ Validator correctly rejected: $p"
            }
          }

      - name: Upload proof artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bap-proof-seal-artifacts
          path: |
            docs/examples/proof_run