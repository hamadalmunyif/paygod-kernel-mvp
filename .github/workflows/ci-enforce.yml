name: Paygod CI Enforcement

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  enforce:
    runs-on: ubuntu-latest

    env:
      PAYGOD_CLOCK: 2026-02-15T00:00:00Z
      SOURCE_DATE_EPOCH: "0"
      PAYGOD_STRICT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build CLI
        run: dotnet build ./src/PayGod.Cli/PayGod.Cli.csproj --configuration Release

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Runner Image
        run: docker buildx build --load -f deploy/docker/runner/Dockerfile -t paygod/runner:ci .

      - name: Tag Runner Image as dev (for witness script)
        run: docker tag paygod/runner:ci paygod/runner:dev

      - name: Debug tools directory (case-sensitive on Linux)
        shell: pwsh
        run: |
          Get-Location
          Get-ChildItem -Force ./tools | Sort-Object Name | Format-Table -AutoSize Name,Length

      - name: Run deterministic witness
        shell: pwsh
        run: pwsh -NoProfile -File ./tools/phase4_docker_witness.ps1

      - name: Generate bundle (CLI run)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ci_out | Out-Null
          dotnet run --project ./src/PayGod.Cli/PayGod.Cli.csproj -- run --pack ./packs/core/secrets-in-repo-guard --input ./_witness_tmp/input/input.json --out ./ci_out

      - name: Verify bundle
        shell: pwsh
        run: pwsh -NoProfile -File ./tools/run_proof.ps1 -BundlePath ./ci_out


