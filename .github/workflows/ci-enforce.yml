name: Paygod CI Enforcement

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  enforce:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build CLI
        run: dotnet build ./src/PayGod.Cli/PayGod.Cli.csproj --configuration Release

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Build Runner Image
        run: docker build -f deploy/docker/runner/Dockerfile -t paygod/runner:ci .

      - name: Run deterministic witness
        shell: pwsh
        run: pwsh ./tools/phase4_docker_witness.ps1

      - name: Generate bundle (CLI run)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ci_out | Out-Null
          dotnet run --project ./src/PayGod.Cli/PayGod.Cli.csproj -- run `
            --pack ./packs/core/secrets-in-repo-guard `
            --input ./_witness_tmp/input/input.json `
            --out ./ci_out

      - name: Verify bundle
        shell: pwsh
        run: pwsh ./tools/verify_bundle.ps1 -BundlePath ./ci_out
